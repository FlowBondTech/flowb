<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crew Leaderboard -- FlowB</title>
  <meta name="description" content="See which crews are leading ETHDenver 2026. Join a crew and climb the leaderboard!">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container header-inner">
      <a href="/" class="logo">
        <img class="logo-icon" src="flowb.png" alt="FlowB">
        <span class="logo-text">FlowB</span>
      </a>
      <nav class="header-nav">
        <a href="/" class="header-nav-link">Events</a>
        <a href="/leaderboard.html" class="header-nav-link active">Leaderboard</a>
        <a href="/flow.html" class="header-nav-link">My Flow</a>
        <a href="/about.html" class="header-nav-link">About</a>
      </nav>
      <div class="header-meta">
        <span class="event-badge">ETHDenver 2026</span>
        <span class="event-dates">Feb 15 -- 27</span>
        <div class="points-badge" id="pointsBadge" title="Your FlowB Points">
          <div class="points-ring-wrap">
            <svg class="points-ring" width="36" height="36" viewBox="0 0 36 36">
              <circle cx="18" cy="18" r="16" fill="none" stroke="currentColor" stroke-width="2.5" class="points-ring-track"/>
              <circle cx="18" cy="18" r="16" fill="none" stroke="currentColor" stroke-width="2.5" class="points-ring-progress" id="pointsRingProgress"
                stroke-linecap="round" stroke-dasharray="100.53" stroke-dashoffset="100.53" transform="rotate(-90 18 18)"/>
            </svg>
            <span class="points-flame">&#x1F525;</span>
          </div>
          <span class="points-count" id="pointsCount">0</span>
          <div class="points-streak hidden" id="pointsStreak">
            <span class="streak-icon" id="streakIcon"></span>
            <span class="streak-count" id="streakCount"></span>
          </div>
          <div class="points-tooltip" id="pointsTooltip">
            <p class="points-tooltip-title" id="tooltipTitle">0 pts</p>
            <div class="points-tooltip-progress" id="tooltipProgress"></div>
            <p class="points-tooltip-streak hidden" id="tooltipStreak"></p>
          </div>
        </div>
        <button class="auth-btn" id="authBtn">Sign In</button>
        <div class="user-menu hidden" id="userMenu">
          <div class="user-avatar" id="userAvatar">?</div>
          <div class="user-dropdown hidden" id="userDropdown">
            <div class="user-dropdown-header" id="userDropdownHeader"></div>
            <button class="user-dropdown-item" id="logoutBtn">Sign Out</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Milestone Banner -->
  <div class="milestone-banner hidden" id="milestoneBanner">
    <div class="container">
      <div class="milestone-inner">
        <div class="milestone-shimmer"></div>
        <div class="milestone-content">
          <div class="milestone-icon-wrap">&#x1F525;</div>
          <div>
            <p class="milestone-title" id="milestoneTitle"></p>
            <p class="milestone-msg" id="milestoneMsg"></p>
          </div>
        </div>
        <button class="milestone-close" id="milestoneClose">&times;</button>
      </div>
    </div>
  </div>

  <!-- Leaderboard Page Content -->
  <main class="page-content">
    <div class="container">
      <div class="page-header">
        <div class="page-header-text">
          <h1 class="page-title">Crew Leaderboard</h1>
          <p class="page-subtitle">See which crews are leading ETHDenver 2026</p>
        </div>
        <div class="page-header-actions">
          <a href="https://t.me/Flow_b_bot" target="_blank" class="page-action-btn">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
            Join a Crew
          </a>
        </div>
      </div>

      <!-- Top 3 Podium -->
      <div class="lb-podium" id="lbPodium">
        <div class="lb-podium-loading">Loading leaderboard...</div>
      </div>

      <!-- Full Rankings -->
      <div class="lb-rankings" id="lbRankings"></div>

      <!-- Live Stats -->
      <div class="lb-stats" id="lbStats"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container footer-inner">
      <div class="footer-left">
        <img class="logo-icon small" src="flowb.png" alt="FlowB">
        <span>FlowB</span>
        <span class="footer-dot"></span>
        <span class="footer-muted">Powered by eGator</span>
      </div>
      <div class="footer-right">
        <a href="https://t.me/Flow_b_bot" target="_blank" class="footer-link">Telegram Bot</a>
        <a href="https://warpcast.com/flowb" target="_blank" class="footer-link">Farcaster</a>
        <a href="https://flowb.fly.dev/api/v1/events" target="_blank" class="footer-link">API</a>
      </div>
    </div>
  </footer>

  <!-- Points Toast Container -->
  <div class="points-toasts" id="pointsToasts"></div>

  <!-- Privy Auth Mount -->
  <div id="privy-root"></div>

  <script src="points.js"></script>
  <script src="auth.js"></script>
  <script>
    const FLOWB_API = 'https://flowb.fly.dev';

    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function formatNumber(n) {
      if (n >= 10000) return (n / 1000).toFixed(1) + 'k';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
      return String(n);
    }

    async function loadLeaderboard() {
      const podiumEl = document.getElementById('lbPodium');
      const rankingsEl = document.getElementById('lbRankings');

      try {
        const res = await fetch(`${FLOWB_API}/api/v1/flow/leaderboard`);
        if (!res.ok) throw new Error('Failed to load');
        const data = await res.json();
        const crews = data.crews || [];

        if (!crews.length) {
          podiumEl.innerHTML = '<div class="lb-empty">No crews yet. Be the first to create one!</div>';
          return;
        }

        // Top 3 Podium
        const top3 = crews.slice(0, 3);
        const podiumOrder = [1, 0, 2]; // silver, gold, bronze display order
        podiumEl.innerHTML = '<div class="lb-podium-row">' + podiumOrder.map(i => {
          const crew = top3[i];
          if (!crew) return '';
          const place = i + 1;
          const medal = place === 1 ? '#fbbf24' : place === 2 ? '#94a3b8' : '#cd7f32';
          const height = place === 1 ? '140px' : place === 2 ? '110px' : '90px';
          return `
            <div class="lb-podium-item lb-podium-${place}">
              <div class="lb-podium-emoji">${crew.emoji || ''}</div>
              <div class="lb-podium-name">${escapeHtml(crew.name)}</div>
              <div class="lb-podium-pts">${crew.totalPoints} pts</div>
              ${crew.memberCount ? `<div class="lb-podium-members">${crew.memberCount} members</div>` : ''}
              <div class="lb-podium-bar" style="height:${height};background:linear-gradient(to top, ${medal}22, ${medal}44);">
                <span class="lb-podium-rank" style="color:${medal}">${place}</span>
              </div>
            </div>
          `;
        }).join('') + '</div>';

        // Full rankings (4+)
        const rest = crews.slice(3);
        if (rest.length) {
          rankingsEl.innerHTML = '<div class="lb-table">' +
            rest.map((crew, i) => {
              const rank = i + 4;
              return `
                <div class="lb-row">
                  <span class="lb-row-rank">${rank}</span>
                  <span class="lb-row-emoji">${crew.emoji || ''}</span>
                  <div class="lb-row-info">
                    <span class="lb-row-name">${escapeHtml(crew.name)}</span>
                    ${crew.memberCount ? `<span class="lb-row-members">${crew.memberCount} members</span>` : ''}
                  </div>
                  <span class="lb-row-pts">${crew.totalPoints} pts</span>
                </div>
              `;
            }).join('') +
          '</div>';
        }
      } catch (err) {
        podiumEl.innerHTML = '<div class="lb-empty">Could not load leaderboard. Try again later.</div>';
      }
    }

    async function loadStats() {
      try {
        const res = await fetch(`${FLOWB_API}/api/v1/stats`);
        if (!res.ok) return;
        const stats = await res.json();
        const el = document.getElementById('lbStats');
        el.innerHTML = `
          <div class="lb-stats-row">
            <div class="lb-stat-card">
              <div class="lb-stat-val">${stats.crewsActive || 0}</div>
              <div class="lb-stat-label">Active Crews</div>
            </div>
            <div class="lb-stat-card">
              <div class="lb-stat-val">${formatNumber(stats.totalPoints || 0)}</div>
              <div class="lb-stat-label">Total Points</div>
            </div>
            <div class="lb-stat-card">
              <div class="lb-stat-val">${stats.checkinsToday || 0}</div>
              <div class="lb-stat-label">Checkins Today</div>
            </div>
          </div>
        `;
      } catch {}
    }

    // Init
    loadLeaderboard();
    loadStats();
  </script>
  <script>
    (function() {
      var loaded = false;
      function loadPrivy() {
        if (loaded) return;
        loaded = true;
        var s = document.createElement('script');
        s.type = 'module';
        s.src = '/privy-mount.js';
        document.body.appendChild(s);
      }
      if (localStorage.getItem('flowb-auth')) {
        loadPrivy();
      } else {
        var btn = document.getElementById('authBtn');
        if (btn) btn.addEventListener('click', function() {
          loadPrivy();
          setTimeout(function() {
            if (window.flowbPrivy) window.flowbPrivy.login();
          }, 1500);
        }, { once: true });
      }
    })();
  </script>
</body>
</html>
