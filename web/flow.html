<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Flow -- FlowB</title>
  <meta name="description" content="Your personal ETHDenver 2026 dashboard. Track your schedule, crews, points, and connections.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container header-inner">
      <a href="/" class="logo">
        <img class="logo-icon" src="flowb.png" alt="FlowB">
        <span class="logo-text">FlowB</span>
      </a>
      <nav class="header-nav">
        <a href="/" class="header-nav-link">Events</a>
        <a href="/leaderboard.html" class="header-nav-link">Leaderboard</a>
        <a href="/flow.html" class="header-nav-link active">My Flow</a>
        <a href="/about.html" class="header-nav-link">About</a>
      </nav>
      <div class="header-meta">
        <span class="event-badge">ETHDenver 2026</span>
        <span class="event-dates">Feb 15 -- 27</span>
        <div class="points-badge" id="pointsBadge" title="Your FlowB Points">
          <div class="points-ring-wrap">
            <svg class="points-ring" width="36" height="36" viewBox="0 0 36 36">
              <circle cx="18" cy="18" r="16" fill="none" stroke="currentColor" stroke-width="2.5" class="points-ring-track"/>
              <circle cx="18" cy="18" r="16" fill="none" stroke="currentColor" stroke-width="2.5" class="points-ring-progress" id="pointsRingProgress"
                stroke-linecap="round" stroke-dasharray="100.53" stroke-dashoffset="100.53" transform="rotate(-90 18 18)"/>
            </svg>
            <span class="points-flame">&#x1F525;</span>
          </div>
          <span class="points-count" id="pointsCount">0</span>
          <div class="points-streak hidden" id="pointsStreak">
            <span class="streak-icon" id="streakIcon"></span>
            <span class="streak-count" id="streakCount"></span>
          </div>
          <div class="points-tooltip" id="pointsTooltip">
            <p class="points-tooltip-title" id="tooltipTitle">0 pts</p>
            <div class="points-tooltip-progress" id="tooltipProgress"></div>
            <p class="points-tooltip-streak hidden" id="tooltipStreak"></p>
          </div>
        </div>
        <button class="auth-btn" id="authBtn">Sign In</button>
        <div class="user-menu hidden" id="userMenu">
          <div class="user-avatar" id="userAvatar">?</div>
          <div class="user-dropdown hidden" id="userDropdown">
            <div class="user-dropdown-header" id="userDropdownHeader"></div>
            <button class="user-dropdown-item" onclick="window.location='/settings.html'">Settings</button>
            <button class="user-dropdown-item" id="logoutBtn">Sign Out</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Milestone Banner -->
  <div class="milestone-banner hidden" id="milestoneBanner">
    <div class="container">
      <div class="milestone-inner">
        <div class="milestone-shimmer"></div>
        <div class="milestone-content">
          <div class="milestone-icon-wrap">&#x1F525;</div>
          <div>
            <p class="milestone-title" id="milestoneTitle"></p>
            <p class="milestone-msg" id="milestoneMsg"></p>
          </div>
        </div>
        <button class="milestone-close" id="milestoneClose">&times;</button>
      </div>
    </div>
  </div>

  <!-- Flow Page Content -->
  <main class="page-content">
    <div class="container">

      <!-- Sign-in Gate (shown when not authenticated) -->
      <div class="flow-signin-gate" id="flowSigninGate">
        <div class="flow-signin-card">
          <div class="flow-signin-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
              <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/>
            </svg>
          </div>
          <h2 class="flow-signin-title">Sign in to see My Flow</h2>
          <p class="flow-signin-msg">Track your schedule, manage crews, earn points, and connect with friends at ETHDenver 2026.</p>
          <button class="flow-signin-btn" id="flowSigninBtn">Sign In</button>
          <div class="flow-signin-links">
            <span>Or use FlowB on</span>
            <a href="https://t.me/Flow_b_bot" target="_blank">Telegram</a>
            <span>/</span>
            <a href="https://warpcast.com/flowb" target="_blank">Farcaster</a>
          </div>
        </div>
      </div>

      <!-- Authenticated Content -->
      <div class="flow-authed hidden" id="flowAuthed">
        <div class="page-header">
          <div class="page-header-text">
            <h1 class="page-title">My Flow</h1>
            <p class="page-subtitle" id="flowGreeting">Your ETHDenver 2026 dashboard</p>
          </div>
          <div class="page-header-actions">
            <a href="/settings.html" class="page-action-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
              Settings
            </a>
            <a href="https://t.me/Flow_b_bot" target="_blank" class="page-action-btn secondary">
              <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
              Telegram
            </a>
            <a href="https://warpcast.com/flowb" target="_blank" class="page-action-btn secondary">
              <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M18.24 2.4H5.76C3.96 2.4 2.4 3.96 2.4 5.76v12.48c0 1.8 1.56 3.36 3.36 3.36h12.48c1.8 0 3.36-1.56 3.36-3.36V5.76c0-1.8-1.56-3.36-3.36-3.36zm-.84 14.4h-1.44l-.72-3.6-.72 3.6H13.2l-1.2-6h1.44l.6 3.6.72-3.6h1.2l.72 3.6.6-3.6h1.44l-1.32 6z"/></svg>
              Farcaster
            </a>
          </div>
        </div>

        <!-- Profile Card -->
        <div id="flowProfile"></div>

        <!-- Content Grid -->
        <div class="flow-grid">
          <!-- My Schedule -->
          <div class="flow-card">
            <div class="flow-card-header">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              <span>My Schedule</span>
              <span class="flow-card-badge" id="flowScheduleCount"></span>
            </div>
            <div class="flow-card-body" id="flowSchedule">
              <div class="flow-loading">Loading...</div>
            </div>
          </div>

          <!-- My Crews -->
          <div class="flow-card flow-card-wide">
            <div class="flow-card-header">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
              <span>My Crews</span>
              <span class="flow-card-badge" id="flowCrewsCount"></span>
              <div class="flow-card-actions">
                <button class="flow-card-action-btn" id="crewDiscoverBtn" title="Discover crews">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                  Discover
                </button>
                <button class="flow-card-action-btn" id="crewCreateBtn" title="Create a crew">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                  Create
                </button>
                <button class="flow-card-action-btn" id="crewJoinCodeBtn" title="Join with code">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                  Code
                </button>
              </div>
            </div>
            <div class="flow-card-body" id="flowCrews">
              <div class="flow-loading">Loading...</div>
            </div>

            <!-- Discover Crews Panel (hidden by default) -->
            <div class="crew-panel hidden" id="crewDiscoverPanel">
              <div class="crew-panel-header">
                <h3>Discover Crews</h3>
                <button class="crew-panel-close" id="crewDiscoverClose">&times;</button>
              </div>
              <div class="crew-panel-body" id="crewDiscoverList">
                <div class="flow-loading">Loading crews...</div>
              </div>
            </div>
          </div>

          <!-- Create Crew Modal -->
          <div class="crew-modal-backdrop hidden" id="crewCreateBackdrop"></div>
          <div class="crew-modal hidden" id="crewCreateModal">
            <div class="crew-modal-header">
              <h3>Create a Crew</h3>
              <button class="crew-panel-close" id="crewCreateClose">&times;</button>
            </div>
            <div class="crew-modal-body">
              <div class="crew-form-group">
                <label>Emoji</label>
                <input type="text" id="crewCreateEmoji" maxlength="4" placeholder="Pick one..." class="crew-input crew-input-emoji">
              </div>
              <div class="crew-form-group">
                <label>Crew Name</label>
                <input type="text" id="crewCreateName" maxlength="40" placeholder="My awesome crew" class="crew-input">
              </div>
              <div class="crew-form-group">
                <label>Description <span class="crew-form-opt">(optional)</span></label>
                <input type="text" id="crewCreateDesc" maxlength="120" placeholder="What's your crew about?" class="crew-input">
              </div>
              <button class="crew-submit-btn" id="crewCreateSubmit">Create Crew</button>
              <p class="crew-form-note" id="crewCreateMsg"></p>
            </div>
          </div>

          <!-- Join by Code Modal -->
          <div class="crew-modal-backdrop hidden" id="crewJoinBackdrop"></div>
          <div class="crew-modal hidden" id="crewJoinModal">
            <div class="crew-modal-header">
              <h3>Join by Code</h3>
              <button class="crew-panel-close" id="crewJoinClose">&times;</button>
            </div>
            <div class="crew-modal-body">
              <p class="crew-form-hint">Enter a crew's join code or invite link to join.</p>
              <div class="crew-form-group">
                <label>Join Code</label>
                <input type="text" id="crewJoinCode" maxlength="20" placeholder="e.g. abc123" class="crew-input">
              </div>
              <button class="crew-submit-btn" id="crewJoinSubmit">Join Crew</button>
              <p class="crew-form-note" id="crewJoinMsg"></p>
            </div>
          </div>

          <!-- Points & Milestones -->
          <div class="flow-card">
            <div class="flow-card-header">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
              <span>Points & Milestones</span>
            </div>
            <div class="flow-card-body" id="flowPoints">
              <div class="flow-loading">Loading...</div>
            </div>
          </div>

          <!-- Connections -->
          <div class="flow-card">
            <div class="flow-card-header">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
              <span>Connections</span>
            </div>
            <div class="flow-card-body" id="flowFriends">
              <div class="flow-loading">Loading...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container footer-inner">
      <div class="footer-left">
        <img class="logo-icon small" src="flowb.png" alt="FlowB">
        <span>FlowB</span>
        <span class="footer-dot"></span>
        <span class="footer-muted">Powered by eGator</span>
      </div>
      <div class="footer-right">
        <a href="https://t.me/Flow_b_bot" target="_blank" class="footer-link">Telegram Bot</a>
        <a href="https://warpcast.com/flowb" target="_blank" class="footer-link">Farcaster</a>
        <a href="https://flowb.fly.dev/api/v1/events" target="_blank" class="footer-link">API</a>
      </div>
    </div>
  </footer>

  <!-- Points Toast Container -->
  <div class="points-toasts" id="pointsToasts"></div>

  <!-- Privy Auth Mount -->
  <div id="privy-root"></div>

  <script src="points.js"></script>
  <script src="auth.js"></script>
  <script>
    const FLOWB_API = 'https://flowb.fly.dev';

    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function getAuthToken() {
      return Auth.jwt || localStorage.getItem('flowb-jwt') || null;
    }

    async function fetchAuthed(path, opts = {}) {
      const token = getAuthToken();
      if (!token) return null;
      try {
        const res = await fetch(`${FLOWB_API}${path}`, {
          ...opts,
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
            ...(opts.headers || {}),
          },
        });
        if (!res.ok) return null;
        return await res.json();
      } catch { return null; }
    }

    // ===== Auth State =====

    function updateFlowPage() {
      const gate = document.getElementById('flowSigninGate');
      const authed = document.getElementById('flowAuthed');

      if (Auth.isAuthenticated && Auth.jwt) {
        gate.classList.add('hidden');
        authed.classList.remove('hidden');
        loadFlowData();
      } else {
        gate.classList.remove('hidden');
        authed.classList.add('hidden');
      }
    }

    window.addEventListener('flowb-auth-ready', () => setTimeout(updateFlowPage, 200));
    window.addEventListener('privy-auth-change', () => setTimeout(updateFlowPage, 500));

    // Sign-in button
    document.getElementById('flowSigninBtn')?.addEventListener('click', () => {
      if (window.flowbPrivy) {
        window.flowbPrivy.login();
      } else {
        document.getElementById('authBtn')?.click();
      }
    });

    // ===== Load Flow Data =====

    async function loadFlowData() {
      loadProfile();
      loadSchedule();
      loadCrews();
      loadPoints();
      loadFriends();
    }

    async function loadProfile() {
      const el = document.getElementById('flowProfile');
      if (!el || !Auth.user) return;

      const displayName = Auth.user.username || Auth.user.email || 'User';
      const initial = displayName[0].toUpperCase();
      const pointsData = await fetchAuthed('/api/v1/me/points');
      const totalPts = pointsData?.total_points ?? Points.total;
      const streak = pointsData?.current_streak ?? Points.streak;
      const milestone = getMilestoneForPoints(totalPts);

      // Update greeting
      document.getElementById('flowGreeting').textContent = `Welcome back, ${displayName}`;

      el.innerHTML = `
        <div class="dash-profile-card">
          <div class="dash-avatar">${initial}</div>
          <div class="dash-profile-info">
            <h3 class="dash-username">${escapeHtml(displayName)}</h3>
            <p class="dash-user-meta">${Auth.user.email ? escapeHtml(Auth.user.email) : Auth.user.wallet ? escapeHtml(Auth.user.wallet.slice(0,6) + '...' + Auth.user.wallet.slice(-4)) : 'Connected via Privy'}</p>
          </div>
          <div class="dash-stats-row">
            <div class="dash-stat">
              <span class="dash-stat-val">${totalPts}</span>
              <span class="dash-stat-label">Points</span>
            </div>
            <div class="dash-stat">
              <span class="dash-stat-val">${streak}${streak > 2 ? ' \uD83D\uDD25' : ''}</span>
              <span class="dash-stat-label">Day Streak</span>
            </div>
            <div class="dash-stat">
              <span class="dash-stat-val">${milestone ? milestone.title : 'Newcomer'}</span>
              <span class="dash-stat-label">Rank</span>
            </div>
          </div>
        </div>
      `;
    }

    async function loadSchedule() {
      const el = document.getElementById('flowSchedule');
      if (!el) return;

      const data = await fetchAuthed('/api/v1/me/schedule');
      if (!data || !data.schedule || !data.schedule.length) {
        el.innerHTML = `
          <div class="dash-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="28" height="28"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            <p>No upcoming events yet</p>
            <span>Browse <a href="/">events</a> and hit "Add to My Flow"</span>
          </div>`;
        return;
      }

      const countEl = document.getElementById('flowScheduleCount');
      if (countEl) countEl.textContent = data.schedule.length;

      el.innerHTML = data.schedule.map(item => {
        const date = new Date(item.starts_at);
        const dayStr = date.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
        const dayNum = date.getDate();
        const monStr = date.toLocaleDateString('en-US', { month: 'short' });
        const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const venue = item.venue_name || '';
        const statusClass = item.rsvp_status === 'going' ? 'going' : 'maybe';

        return `
          <div class="dash-event-item">
            <div class="dash-event-date">
              <span class="dash-event-day">${dayStr}</span>
              <span class="dash-event-num">${dayNum}</span>
              <span class="dash-event-mon">${monStr}</span>
            </div>
            <div class="dash-event-info">
              <div class="dash-event-title">${escapeHtml(item.event_title)}</div>
              <div class="dash-event-meta">${timeStr}${venue ? ' &middot; ' + escapeHtml(venue) : ''}</div>
            </div>
            <span class="dash-event-status ${statusClass}">${item.rsvp_status === 'going' ? 'Going' : 'Maybe'}</span>
          </div>
        `;
      }).join('');
    }

    let myCrews = [];

    async function loadCrews() {
      const el = document.getElementById('flowCrews');
      if (!el) return;

      const data = await fetchAuthed('/api/v1/flow/crews');
      myCrews = (data && data.crews) ? data.crews : [];

      const countEl = document.getElementById('flowCrewsCount');
      if (countEl) countEl.textContent = myCrews.length || '';

      if (!myCrews.length) {
        el.innerHTML = `
          <div class="dash-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="28" height="28"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
            <p>No crews yet</p>
            <span>Discover crews, create your own, or join with a code above!</span>
          </div>`;
        return;
      }

      el.innerHTML = myCrews.map(crew => `
        <div class="dash-crew-item">
          <span class="dash-crew-emoji">${crew.emoji || ''}</span>
          <div class="dash-crew-info">
            <div class="dash-crew-name">${escapeHtml(crew.name)}</div>
            <div class="dash-crew-meta">
              <span class="dash-crew-role">${crew.role || 'member'}</span>
              ${crew.join_code ? `<span class="dash-crew-code" title="Share this code">Code: ${escapeHtml(crew.join_code)}</span>` : ''}
            </div>
          </div>
          <button class="crew-leave-btn" title="Leave crew" onclick="leaveCrew('${crew.id}', '${escapeHtml(crew.name).replace(/'/g, "\\'")}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          </button>
        </div>
      `).join('');
    }

    async function leaveCrew(crewId, crewName) {
      if (!confirm('Leave ' + crewName + '?')) return;
      const result = await fetchAuthed('/api/v1/flow/crews/' + crewId + '/leave', { method: 'DELETE' });
      if (result && result.ok) {
        loadCrews();
      }
    }

    // ===== Discover Crews =====

    document.getElementById('crewDiscoverBtn').addEventListener('click', () => {
      const panel = document.getElementById('crewDiscoverPanel');
      panel.classList.toggle('hidden');
      if (!panel.classList.contains('hidden')) {
        loadDiscoverCrews();
      }
    });

    document.getElementById('crewDiscoverClose').addEventListener('click', () => {
      document.getElementById('crewDiscoverPanel').classList.add('hidden');
    });

    async function loadDiscoverCrews() {
      const el = document.getElementById('crewDiscoverList');
      el.innerHTML = '<div class="flow-loading">Loading crews...</div>';

      const data = await fetchAuthed('/api/v1/flow/crews/discover');
      const crews = (data && data.crews) ? data.crews : [];

      if (!crews.length) {
        el.innerHTML = '<div class="dash-empty"><p>No public crews found</p><span>Be the first to create one!</span></div>';
        return;
      }

      // Filter out crews user already belongs to
      const myCrewIds = new Set(myCrews.map(c => c.id));
      const available = crews.filter(c => !myCrewIds.has(c.id));

      if (!available.length) {
        el.innerHTML = '<div class="dash-empty"><p>You\'re in all available crews!</p></div>';
        return;
      }

      el.innerHTML = available.map(crew => `
        <div class="crew-discover-item">
          <span class="dash-crew-emoji">${crew.emoji || ''}</span>
          <div class="dash-crew-info">
            <div class="dash-crew-name">${escapeHtml(crew.name)}</div>
            <div class="dash-crew-meta">
              ${crew.description ? `<span class="dash-crew-desc">${escapeHtml(crew.description)}</span>` : ''}
              <span class="dash-crew-members">${crew.member_count || 0} members</span>
            </div>
          </div>
          <button class="crew-join-btn" onclick="joinCrew('${crew.id}', this)">Join</button>
        </div>
      `).join('');
    }

    async function joinCrew(crewId, btnEl) {
      btnEl.disabled = true;
      btnEl.textContent = 'Joining...';

      const result = await fetchAuthed('/api/v1/flow/crews/' + crewId + '/join', {
        method: 'POST',
        body: JSON.stringify({}),
      });

      if (result && result.ok) {
        btnEl.textContent = 'Joined!';
        btnEl.classList.add('joined');
        loadCrews();
      } else {
        btnEl.textContent = result?.message || 'Failed';
        btnEl.disabled = false;
        setTimeout(() => { btnEl.textContent = 'Join'; }, 2000);
      }
    }

    // ===== Create Crew =====

    function openCreateCrew() {
      document.getElementById('crewCreateModal').classList.remove('hidden');
      document.getElementById('crewCreateBackdrop').classList.remove('hidden');
      document.getElementById('crewCreateMsg').textContent = '';
      document.body.style.overflow = 'hidden';
    }
    function closeCreateCrew() {
      document.getElementById('crewCreateModal').classList.add('hidden');
      document.getElementById('crewCreateBackdrop').classList.add('hidden');
      document.body.style.overflow = '';
    }

    document.getElementById('crewCreateBtn').addEventListener('click', openCreateCrew);
    document.getElementById('crewCreateClose').addEventListener('click', closeCreateCrew);
    document.getElementById('crewCreateBackdrop').addEventListener('click', closeCreateCrew);

    document.getElementById('crewCreateSubmit').addEventListener('click', async () => {
      const name = document.getElementById('crewCreateName').value.trim();
      const emoji = document.getElementById('crewCreateEmoji').value.trim();
      const desc = document.getElementById('crewCreateDesc').value.trim();
      const msgEl = document.getElementById('crewCreateMsg');
      const btn = document.getElementById('crewCreateSubmit');

      if (!name) { msgEl.textContent = 'Name is required'; return; }

      btn.disabled = true;
      btn.textContent = 'Creating...';

      const result = await fetchAuthed('/api/v1/flow/crews', {
        method: 'POST',
        body: JSON.stringify({ name, emoji: emoji || undefined, description: desc || undefined }),
      });

      if (result && result.ok) {
        msgEl.textContent = result.message || 'Crew created!';
        msgEl.style.color = 'var(--green, #22c55e)';
        document.getElementById('crewCreateName').value = '';
        document.getElementById('crewCreateEmoji').value = '';
        document.getElementById('crewCreateDesc').value = '';
        loadCrews();
        setTimeout(closeCreateCrew, 1500);
      } else {
        msgEl.textContent = result?.message || result?.error || 'Failed to create crew';
        msgEl.style.color = 'var(--red, #ef4444)';
      }

      btn.disabled = false;
      btn.textContent = 'Create Crew';
    });

    // ===== Join by Code =====

    function openJoinCode() {
      document.getElementById('crewJoinModal').classList.remove('hidden');
      document.getElementById('crewJoinBackdrop').classList.remove('hidden');
      document.getElementById('crewJoinMsg').textContent = '';
      document.body.style.overflow = 'hidden';
    }
    function closeJoinCode() {
      document.getElementById('crewJoinModal').classList.add('hidden');
      document.getElementById('crewJoinBackdrop').classList.add('hidden');
      document.body.style.overflow = '';
    }

    document.getElementById('crewJoinCodeBtn').addEventListener('click', openJoinCode);
    document.getElementById('crewJoinClose').addEventListener('click', closeJoinCode);
    document.getElementById('crewJoinBackdrop').addEventListener('click', closeJoinCode);

    document.getElementById('crewJoinSubmit').addEventListener('click', async () => {
      let code = document.getElementById('crewJoinCode').value.trim();
      const msgEl = document.getElementById('crewJoinMsg');
      const btn = document.getElementById('crewJoinSubmit');

      if (!code) { msgEl.textContent = 'Enter a join code'; return; }

      // Extract code from full URL if pasted (flowb.me/g/CODE or /gi/CODE)
      const urlMatch = code.match(/\/g[i]?\/([a-zA-Z0-9]+)/);
      if (urlMatch) code = urlMatch[1];

      btn.disabled = true;
      btn.textContent = 'Joining...';

      const result = await fetchAuthed('/api/v1/flow/crews/' + encodeURIComponent(code) + '/join', {
        method: 'POST',
        body: JSON.stringify({ joinCode: code }),
      });

      if (result && result.ok) {
        msgEl.textContent = result.message || 'Joined!';
        msgEl.style.color = 'var(--green, #22c55e)';
        document.getElementById('crewJoinCode').value = '';
        loadCrews();
        setTimeout(closeJoinCode, 1500);
      } else {
        msgEl.textContent = result?.message || result?.error || 'Could not join. Check the code and try again.';
        msgEl.style.color = 'var(--red, #ef4444)';
      }

      btn.disabled = false;
      btn.textContent = 'Join Crew';
    });

    // Close modals on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeCreateCrew();
        closeJoinCode();
      }
    });

    async function loadPoints() {
      const el = document.getElementById('flowPoints');
      if (!el) return;

      const pointsData = await fetchAuthed('/api/v1/me/points');
      const totalPts = pointsData?.total_points ?? Points.total;
      const next = getNextMilestone(totalPts);
      const progress = getMilestoneProgress(totalPts);

      let html = '';
      if (next) {
        html += `
          <div class="dash-milestone-progress">
            <div class="dash-milestone-header">
              <span>Progress to <strong>${next.title}</strong></span>
              <span>${totalPts} / ${next.points}</span>
            </div>
            <div class="dash-progress-bar">
              <div class="dash-progress-fill" style="width:${progress * 100}%"></div>
            </div>
            <p class="dash-milestone-hint">${next.points - totalPts} points to go</p>
          </div>
        `;
      } else {
        html += '<div class="dash-milestone-progress"><p class="dash-milestone-maxed">You\'ve reached the highest rank!</p></div>';
      }

      const achieved = MILESTONES.filter(m => totalPts >= m.points);
      if (achieved.length) {
        html += '<div class="dash-achieved">';
        for (const m of achieved) {
          html += `<span class="dash-achieved-badge">Lv${m.level} ${m.title}</span>`;
        }
        html += '</div>';
      }

      el.innerHTML = html;
    }

    async function loadFriends() {
      const el = document.getElementById('flowFriends');
      if (!el) return;

      const data = await fetchAuthed('/api/v1/flow/friends');
      if (!data || !data.friends || !data.friends.length) {
        el.innerHTML = `
          <div class="dash-empty dash-empty-sm">
            <p>No connections yet</p>
            <span>Share your invite link to connect with friends</span>
          </div>`;
        return;
      }

      el.innerHTML = data.friends.slice(0, 12).map(f => `
        <div class="dash-friend-item">
          <div class="dash-friend-avatar">${(f.username || '?')[0].toUpperCase()}</div>
          <span class="dash-friend-name">${escapeHtml(f.username || 'User')}</span>
        </div>
      `).join('');
    }

    // Init
    updateFlowPage();
  </script>
  <script>
    (function() {
      var loaded = false;
      function loadPrivy() {
        if (loaded) return;
        loaded = true;
        var s = document.createElement('script');
        s.type = 'module';
        s.src = '/privy-mount.js';
        document.body.appendChild(s);
      }
      if (localStorage.getItem('flowb-auth')) {
        loadPrivy();
      } else {
        var btn = document.getElementById('authBtn');
        if (btn) btn.addEventListener('click', function() {
          loadPrivy();
          setTimeout(function() {
            if (window.flowbPrivy) window.flowbPrivy.login();
          }, 1500);
        }, { once: true });
      }
    })();
  </script>
</body>
</html>
